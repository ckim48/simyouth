{# templates/scenario_step_gpt.html #}
{% extends "base.html" %}

{% block content %}
<style>
:root{
  --ink:#1a1515; --muted:#736b6b; --primary:#4a3b3b; --secondary:#967d7d;
  --accent:#e5dada; --bg:#f8f7f7; --edge:rgba(0,0,0,.08);
  --shadow-lg:0 20px 40px rgba(0,0,0,.06);
  --radius-md:16px;
  --transition: all 0.3s ease;
}

body { background-color: var(--bg); }

.split-container{ display:grid; grid-template-columns:420px 1fr; min-height:100vh; }

/* --- Sidebar/Narrative Column --- */
.narrative-col{
  background:#fff; border-right:1px solid var(--edge); padding:2rem;
  height:100vh; position:sticky; top:0; overflow-y:auto; z-index:10;
}

.hero-img-wrap {
  width: 100%;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: #fdfcfc;
  margin-bottom: 1.5rem;
  transition: var(--transition);
  border: 1px solid var(--edge);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* State: Image is Active */
.hero-img-wrap:has(img) {
  aspect-ratio: 1/1;
  box-shadow: var(--shadow-lg);
}

/* State: Image is OFF or Placeholder (Compact Mode) */
.hero-img-wrap:has(.img-empty) {
  aspect-ratio: auto;
  padding: 0.75rem;
  box-shadow: none;
  background: rgba(0,0,0,0.02);
  border-style: dashed;
}

.hero-img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

.img-empty {
  text-align: center;
  color: var(--secondary);
  font-size: 0.7rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.img-empty p { margin: 0; opacity: 0.6; }

.story-sofar{ background:#fafafa; padding:1.5rem; border-radius:var(--radius-md); border:1px solid var(--edge); }
.story-sofar h4{ font-size:.75rem; text-transform:uppercase; letter-spacing:.1em; color:var(--secondary); margin-bottom:.8rem; font-weight:800; margin-top:0; }
.story-sofar p{ font-size:.95rem; color:var(--muted); line-height:1.6; margin:0; }

/* --- Main Interaction Column --- */
.interaction-col{ padding:4rem 10%; display:flex; flex-direction:column; align-items:center; }
.content-width{ width:100%; max-width:650px; }

.step-meta{ margin-bottom:2.5rem; }
.count{ font-size:.8rem; font-weight:800; text-transform:uppercase; color:var(--secondary); letter-spacing:.05em; }
.badge-gpt { font-size: 0.65rem; background: var(--accent); padding: 2px 8px; border-radius: 4px; margin-left: 8px; vertical-align: middle; color: var(--primary); }

.progress-track{ height:6px; background:#e8e3e3; border-radius:10px; margin-top:8px; overflow:hidden; }
.progress-fill{ height:100%; background:var(--secondary); transition:width .8s ease; }

.situation-box h1{ font-size:2.25rem; font-weight:850; color:var(--primary); letter-spacing:-.03em; margin-bottom:1rem; }
.situation-text{ font-size:1.15rem; line-height:1.7; color:#444; margin-bottom:2rem; }

/* --- Form Elements --- */
.options-list{ display:flex; flex-direction:column; gap:1rem; }
.option-label{
  display:flex; gap:1.2rem; padding:1.5rem; border:2px solid transparent; background:#fff;
  border-radius:var(--radius-md); cursor:pointer; transition:all .2s ease; box-shadow:0 4px 12px rgba(0,0,0,0.03);
}
.option-label:hover{ transform:translateX(8px); border-color:var(--accent); }
.option-label:has(input:checked){ border-color:var(--secondary); background:#fffcfc; }

.option-label input{ appearance:none; width:22px; height:22px; flex-shrink:0; border:2px solid #dcdcdc; border-radius:50%; margin-top:2px; }
.option-label input:checked{ background:var(--secondary); border-color:var(--secondary); box-shadow:inset 0 0 0 4px #fff; }

.btn-submit{ width:100%; margin-top:3rem; padding:1.25rem; border-radius:14px; background:var(--primary); color:#fff; border:none; font-weight:800; font-size:1.1rem; cursor:pointer; transition: opacity 0.2s; }
.btn-submit:hover { opacity: 0.9; }

@media (max-width:1024px){
  .split-container{ grid-template-columns:1fr; }
  .narrative-col{ height:auto; position:relative; border-right:none; padding:1.5rem; }
  .interaction-col { padding: 2rem 1.5rem; }
}
</style>

<div class="split-container">
  <aside class="narrative-col">
    <div class="hero-img-wrap">
      {% if show_images %}
        {% if hero_image_url %}
          <img src="{{ hero_image_url }}" alt="AI Generated Scene">
        {% else %}
          <div class="img-empty">
            <p>Processing Scene...</p>
          </div>
        {% endif %}
      {% else %}
        <div class="img-empty">
          <p>Visual Experience Off</p>
        </div>
      {% endif %}
    </div>

    <div class="story-sofar">
      <h4>The Story So Far</h4>
      <p>{{ story_so_far or "The journey begins here..." }}</p>
      <div style="margin-top:1.5rem; font-size:.8rem; color:var(--secondary); border-top:1px solid var(--edge); padding-top:1rem;">
        <p><strong>Scenario:</strong> {{ scenario_title }}</p>
      </div>
    </div>
  </aside>

  <main class="interaction-col">
    <div class="content-width">
      <header class="step-meta">
        <span class="count">
          Step {{ step_index }} / {{ total_steps }}
          <span class="badge-gpt">AI GENERATED</span>
        </span>
        <div class="progress-track">
          <div class="progress-fill" style="width: {{ (step_index / total_steps * 100) | round(0) }}%"></div>
        </div>
      </header>

      <section class="situation-box">
        <h1>Current Situation</h1>
        <div class="situation-text">
          {{ situation_text }}
        </div>
        <p style="font-weight: 800; color: var(--primary); font-size: 1.15rem; margin-bottom: 1.5rem; line-height: 1.4;">
          {{ step.question }}
        </p>
      </section>

      <form method="post" action="{{ url_for('gpt_scenario_step', step=step_index) }}">
        <div class="options-list">
          {% for opt in step.options %}
            <label class="option-label">
              <input type="radio" name="choice" value="{{ opt.value }}"
                     {% if selected == opt.value %}checked{% endif %} required>
              <div>
                <p style="margin:0; font-weight:800; font-size: 1.05rem;">{{ opt.label }}</p>
                {% if opt.hint %}
                  <p style="margin:.35rem 0 0; color:var(--muted); font-size: 0.9rem; line-height: 1.4;">{{ opt.hint }}</p>
                {% endif %}
              </div>
            </label>
          {% endfor %}
        </div>

        <button class="btn-submit" type="submit">
          {% if is_last %}Finalize Experience{% else %}Continue Decision{% endif %}
        </button>
      </form>
    </div>
  </main>
</div>
{% endblock %}