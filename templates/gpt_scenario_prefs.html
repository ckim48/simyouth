{# templates/gpt_scenario_prefs.html (FULL UPDATED — adds Custom/Fiction War mode) #}
{% extends "base.html" %}
{% block content %}

<style>
:root {
  --ink: #1e293b;
  --muted: #64748b;
  --primary: #574545;
  --secondary: #ab8e8e;
  --accent: #f1f5f9;
  --bg: #f8fafc;
  --surface: rgba(255, 255, 255, 0.85);
  --edge: rgba(0, 0, 0, 0.08);
  --shadow: 0 12px 40px rgba(0, 0, 0, 0.04);
}
body {
  background: radial-gradient(circle at top left, #fdfcfc, #f5f2f2);
  color: var(--ink);
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
}
.page { max-width: 850px; margin: 0 auto; padding: 3rem 1.5rem; }
.header-section { margin-bottom: 3rem; text-align: center; }
.header-section h1 { font-weight: 850; font-size: 2.25rem; color: var(--primary); letter-spacing: -0.03em; }
.header-section p { color: var(--muted); font-size: 1.1rem; max-width: 600px; margin: 0.5rem auto; }
.config-card {
  background: var(--surface);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--edge);
  border-radius: 24px;
  box-shadow: var(--shadow);
  padding: 2.5rem;
}
.form-label { font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.95rem; display: block; }
.modern-input {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 2px solid #edf2f7;
  border-radius: 14px;
  background: #fff;
  transition: all 0.2s ease;
  color: var(--ink);
  font-size: 1rem;
}
.modern-input:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 4px rgba(171, 142, 142, 0.15);
}
.mode-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #f8fafc;
  padding: 1.25rem;
  border-radius: 16px;
  border: 1px solid var(--edge);
  margin-top: 1rem;
}
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; inset: 0;
  background-color: #cbd5e1;
  transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px;
  left: 4px; bottom: 4px; background-color: white;
  transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(24px); }

.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.full-width { grid-column: span 2; }

.btn-generate {
  width: 100%;
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 1.1rem;
  border-radius: 16px;
  font-weight: 800;
  font-size: 1.1rem;
  margin-top: 2rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}
.btn-generate:hover {
  background: #3f3434;
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(87, 69, 69, 0.25);
}

/* Custom war section */
.custom-war-wrap {
  border: 1px solid var(--edge);
  background: rgba(255,255,255,0.7);
  border-radius: 18px;
  padding: 1.25rem;
}
.badge-mini{
  display:inline-flex;
  gap:.4rem;
  align-items:center;
  padding:.25rem .6rem;
  border-radius:999px;
  border:1px solid var(--edge);
  background:#fff;
  color:var(--muted);
  font-size:.8rem;
  font-weight:700;
}
.hint{
  color:var(--muted);
  font-size:.92rem;
  margin:.35rem 0 0;
}
.hr-soft{
  height:1px; border:0; background:rgba(0,0,0,.06); margin:1rem 0;
}

/* Hide helper */
.hidden { display: none !important; }

@media (max-width: 640px) {
  .grid-container { grid-template-columns: 1fr; }
  .full-width { grid-column: span 1; }
}
#loading-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(255, 255, 255, 0.9);
  z-index: 10000;
  backdrop-filter: blur(10px);
}
</style>

<div class="page">
  <div class="header-section">
    <h1>Scenario Architect</h1>
    <p>Configure a custom AI-driven ethical experience. Choose your perspective and witness the human side of history.</p>
  </div>

  <div class="config-card">
    <form method="post" action="{{ url_for('gpt_scenario_prefs') }}" onsubmit="return beforeSubmit();">
      <div class="grid-container">

        <div class="full-width">
          <label class="form-label" for="war">Historical Context</label>
          <select id="war" name="war" class="modern-input" required>
            <option value="" disabled selected>Select a historical conflict</option>

            <optgroup label="Custom">
              <option value="custom-war">Custom / Fictional War</option>
            </optgroup>

            <optgroup label="Modern Era">
              <option value="ww2">World War II (1939–1945)</option>
              <option value="korean-war">Korean War (1950–1953)</option>
              <option value="vietnam-war">Vietnam War (1955–1975)</option>
              <option value="bosnian-war">Bosnian War (1992–1995)</option>
              <option value="iraq-war-2003">Iraq War (2003–2011)</option>
            </optgroup>

            <optgroup label="Historical Era">
              <option value="ww1">World War I (1914–1918)</option>
              <option value="american-civil-war">American Civil War (1861–1865)</option>
              <option value="napoleonic-wars">Napoleonic Wars (1803–1815)</option>
              <option value="peloponnesian-war">Peloponnesian War (Ancient Greece)</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label class="form-label" for="role">Your Perspective</label>
          <select id="role" name="role" class="modern-input">
            <option value="student" selected>School Student (Yarova school life)</option>
            <option value="field-commander">Field Commander</option>
            <option value="medic">Field Medic</option>
            <option value="war-reporter">War Reporter</option>
            <option value="humanitarian-coordinator">Relief Worker</option>
          </select>
        </div>

        <div id="theatreSelectWrap">
          <label class="form-label" for="theatre">Specific Front</label>
          <select id="theatre" name="theatre" class="modern-input">
            <option value="" selected>Auto-suggested by AI</option>
          </select>
        </div>

        <div id="theatreCustomWrap" class="hidden">
          <label class="form-label" for="custom_theatre">Front / Region Name</label>
          <input id="custom_theatre" name="custom_theatre" type="text" class="modern-input"
                 placeholder="e.g. North River Corridor, Iron Coast, District-7 Perimeter">
        </div>

        <div>
          <label class="form-label" for="tone">Narrative Style</label>
          <select id="tone" name="tone" class="modern-input">
            <option value="serious & age-appropriate" selected>Educational & Serious</option>
            <option value="reflective">Deeply Reflective</option>
            <option value="case-study">Clinical Case Study</option>
          </select>
        </div>

        <div>
          <label class="form-label" for="goal">Learning Focus</label>
          <input id="goal" name="goal" type="text" class="modern-input" placeholder="e.g. Civilians in crossfire">
        </div>

        {# --- Custom War Panel (shown only when war == custom-war) --- #}
        <div id="customWarPanel" class="full-width hidden">
          <div class="custom-war-wrap">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; flex-wrap:wrap;">
              <div>
                <div class="badge-mini">Custom Mode</div>
                <p class="hint" style="margin-top:.5rem;">
                  Define a fictional conflict setting. Keep it realistic but invented (no real current battlefield names needed).
                </p>
              </div>
            </div>

            <hr class="hr-soft"/>

            <div class="grid-container">
              <div>
                <label class="form-label" for="custom_war_name">War / Conflict Name</label>
                <input id="custom_war_name" name="custom_war_name" type="text" class="modern-input"
                       placeholder="e.g. The Ashfall Conflict">
              </div>

              <div>
                <label class="form-label" for="custom_era">Era / Tech Level</label>
                <select id="custom_era" name="custom_era" class="modern-input">
                  <option value="" selected>Choose (optional)</option>
                  <option value="early-1900s">Early 1900s</option>
                  <option value="mid-1900s">Mid 1900s</option>
                  <option value="modern">Modern</option>
                  <option value="near-future">Near Future</option>
                  <option value="far-future">Far Future</option>
                </select>
              </div>

              <div class="full-width">
                <label class="form-label" for="custom_setting">Setting Summary</label>
                <textarea id="custom_setting" name="custom_setting" class="modern-input" rows="3"
                          placeholder="1–3 sentences: where, why the conflict started, and what civilians are facing."></textarea>
              </div>

              <div>
                <label class="form-label" for="custom_faction_a">Faction A (optional)</label>
                <input id="custom_faction_a" name="custom_faction_a" type="text" class="modern-input"
                       placeholder="e.g. Coastal Union">
              </div>

              <div>
                <label class="form-label" for="custom_faction_b">Faction B (optional)</label>
                <input id="custom_faction_b" name="custom_faction_b" type="text" class="modern-input"
                       placeholder="e.g. Inland Directorate">
              </div>

              <div class="full-width">
                <label class="form-label" for="custom_constraints">Boundaries (optional)</label>
                <input id="custom_constraints" name="custom_constraints" type="text" class="modern-input"
                       placeholder="e.g. avoid gore; focus on ethical dilemmas in evacuation, rationing, truth vs safety">
                <p class="hint">This helps keep the story age-appropriate and aligned with your research goal.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="full-width">
          <div class="mode-toggle">
            <div>
              <span style="font-weight: 700; color: var(--primary); display: block;">Visual Experience</span>
              <small class="text-muted">Show images only if you enable this mode</small>
            </div>
            <label class="switch">
              <input type="checkbox" name="make_image" id="make_image" value="1">
              <span class="slider"></span>
            </label>
          </div>
        </div>

      </div>

      <button class="btn-generate" type="submit" id="submitBtn">Initialize Generation</button>
    </form>
  </div>
</div>

<div id="loading-overlay">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
    <p style="margin-top:1.5rem; color:var(--primary); font-weight:800; font-size:1.2rem;">Architecting Scenario...</p>
    <p class="text-muted">Analyzing historical data and ethical dilemmas.</p>
  </div>
</div>

<script>
function showLoading() {
  document.getElementById('loading-overlay').style.display = 'block';
  document.getElementById('submitBtn').disabled = true;
}

const WAR_THEATRES = {
  "ww1": ["Western Front", "Eastern Front", "Gallipoli"],
  "ww2": ["Europe", "Pacific", "North Africa", "Eastern Front"],
  "korean-war": ["Pusan Perimeter", "Incheon", "Chosin Reservoir"],
  "vietnam-war": ["Central Highlands", "Mekong Delta", "DMZ"],
  "bosnian-war": ["Sarajevo", "Srebrenica", "Mostar"],
  "iraq-war-2003": ["Baghdad", "Fallujah", "Basra"],
  "american-civil-war": ["Gettysburg", "Vicksburg", "Richmond"],
  "napoleonic-wars": ["Iberian Peninsula", "Waterloo", "Russia"],
  "peloponnesian-war": ["Attica", "Sicily", "Hellespont"]
};

const warSel = document.getElementById('war');
const theatreSel = document.getElementById('theatre');
const theatreSelectWrap = document.getElementById('theatreSelectWrap');
const theatreCustomWrap = document.getElementById('theatreCustomWrap');
const customWarPanel = document.getElementById('customWarPanel');

function setCustomMode(isCustom){
  // Show custom war panel
  customWarPanel.classList.toggle('hidden', !isCustom);

  // Swap theatre UI:
  // - real wars: dropdown theatres
  // - custom war: free text region/front
  theatreSelectWrap.classList.toggle('hidden', isCustom);
  theatreCustomWrap.classList.toggle('hidden', !isCustom);

  // For custom, don't force theatre dropdown; for real wars, clear custom theatre
  if(isCustom){
    theatreSel.value = "";
  } else {
    const ct = document.getElementById('custom_theatre');
    if(ct) ct.value = "";
  }
}

function populateTheatresForWarKey(warKey){
  const options = WAR_THEATRES[warKey] || [];
  theatreSel.innerHTML = '<option value="" selected>Auto-suggested by AI</option>';
  options.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    theatreSel.appendChild(opt);
  });
}

warSel.addEventListener('change', () => {
  const isCustom = (warSel.value === "custom-war");
  setCustomMode(isCustom);

  if(!isCustom){
    populateTheatresForWarKey(warSel.value);
  }
});

// Ensure correct initial state (in case browser restores form values)
(function init(){
  const isCustom = (warSel.value === "custom-war");
  setCustomMode(isCustom);
  if(!isCustom && warSel.value){
    populateTheatresForWarKey(warSel.value);
  }
})();

function beforeSubmit(){
  showLoading();

  // Soft validation: if custom-war chosen, at least one of the custom fields should be non-empty
  if(warSel.value === "custom-war"){
    const name = (document.getElementById('custom_war_name').value || "").trim();
    const setting = (document.getElementById('custom_setting').value || "").trim();
    const theatre = (document.getElementById('custom_theatre').value || "").trim();

    // Not hard required, but helps avoid empty custom mode submissions
    if(!name && !setting && !theatre){
      // Allow submit, but could be annoying; better to guide:
      // We'll just re-enable button + hide overlay and prevent submit.
      document.getElementById('loading-overlay').style.display = 'none';
      document.getElementById('submitBtn').disabled = false;
      alert("For Custom / Fictional War, please fill at least one field (Conflict Name, Setting Summary, or Front/Region).");
      return false;
    }
  }

  return true;
}
</script>

{% endblock %}
