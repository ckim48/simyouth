{# templates/profile.html #}
{% extends "base.html" %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --brand-dark: #3f3434;
    --card-shadow: 0 8px 20px -6px rgba(0, 0, 0, 0.05);
    --empty-bg: #f1f5f9;

    /* warm accent palette */
    --launch: #b45309;
    --launch-dark: #92400e;
    --launch-ring: rgba(180,83,9,0.28);
  }

  body { font-family: 'Inter', sans-serif; color: var(--ink); }
  .profile-wrapper { max-width: 1200px; margin: 0 auto; padding-bottom: 60px; }

  .header-accent-line{
    width: 56px; height: 4px; border-radius: 999px;
    background: linear-gradient(90deg, var(--brand), var(--launch));
    opacity: .9;
    margin-top: .6rem;
  }

  .bento-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-bottom: 40px; }
  .bento-card {
    background: #ffffff; border-radius: var(--radius); padding: 24px;
    border: 1px solid var(--line); box-shadow: var(--card-shadow); position: relative;
  }

  .persona-highlight { grid-column: span 7; background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%); color: white; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
  .stat-card-small { grid-column: span 5; }
  .stat-card-med { grid-column: span 6; }
  .stat-card-wide { grid-column: span 12; }

  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; width: 100%; text-align: center; color: var(--muted); padding: 20px;
  }
  .empty-state i { font-size: 1.5rem; margin-bottom: 8px; opacity: 0.5; }
  .empty-state p { font-size: 0.85rem; font-weight: 600; margin: 0; }

  .persona-tag {
    font-size: 0.65rem; font-weight: 900; text-transform: uppercase;
    letter-spacing: 0.12em; margin-bottom: 8px;
    color: rgba(255,255,255,.95);
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  .persona-tag::before{
    content:"";
    width:10px;height:10px;border-radius:999px;
    background: var(--launch);
    box-shadow: 0 0 0 4px rgba(180,83,9,.18);
  }

  .persona-quote { font-size: 1.35rem; font-weight: 700; line-height: 1.3; }
  .card-label { font-size: 0.9rem; font-weight: 800; color: var(--launch); }
  .card-sub { font-size: 0.8rem; color: var(--muted); margin-bottom: 16px; }

  .mission-row { background: white; border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 12px; padding: 16px 20px; }
  .badge-mission { background: rgba(87, 69, 69, 0.08); color: var(--launch); padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; }

  @media (max-width: 992px) { .persona-highlight, .stat-card-small { grid-column: span 12; } }

  .fab-edit{
    position: fixed;
    right: 22px;
    bottom: 22px;
    z-index: 1080;
    border: none;
    border-radius: 999px;
    padding: 12px 16px;
    font-weight: 900;
    box-shadow: 0 14px 30px rgba(0,0,0,.18);
    background: var(--launch);
    color: #fff;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .fab-edit:hover{
    background: var(--launch-dark);
    transform: translateY(-1px);
    box-shadow: 0 18px 36px rgba(0,0,0,.22), 0 0 0 4px var(--launch-ring);
  }
  .fab-dot{
    width:10px;height:10px;border-radius:50%;
    background: rgba(255,255,255,.95);
    box-shadow: 0 0 0 4px rgba(255,255,255,.18);
  }

  .modal .form-label{ font-weight: 800; color: var(--ink); }
  .modal .form-control, .modal .form-select{
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.10);
    padding: .7rem .9rem;
  }
  .modal .form-control:focus, .modal .form-select:focus{
    border-color: var(--brand-light);
    box-shadow: 0 0 0 4px rgba(171, 142, 142, 0.16);
  }

  .btn-save-warm{
    background: var(--launch);
    border: none;
    color: #fff;
    font-weight: 900;
  }
  .btn-save-warm:hover{
    background: var(--launch-dark);
    box-shadow: 0 0 0 4px var(--launch-ring);
  }

  /* ===== Pagination container ===== */
  .pager-wrap{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--line);
  }
  .pager-meta{
    color: var(--muted);
    font-size: .85rem;
    font-weight: 800;
    letter-spacing: .02em;
  }

  /* ===== Pagination – warm launch theme ===== */
  .pagination{
    --pg-bg: #fff;
    --pg-border: var(--line);
    --pg-text: var(--brand);
    --pg-muted: var(--muted);
    --pg-active-bg: var(--launch);
    --pg-active-text: #fff;
    --pg-hover-bg: rgba(180,83,9,0.08);
  }

  .pagination .page-link{
    border-radius: 12px;
    margin: 0 3px;
    padding: 6px 12px;
    font-weight: 800;
    font-size: .8rem;
    color: var(--pg-text);
    background: var(--pg-bg);
    border: 1px solid var(--pg-border);
    transition: background .15s ease, color .15s ease, box-shadow .15s ease;
  }

  .pagination .page-link:hover{
    background: var(--pg-hover-bg);
    color: var(--launch-dark);
  }

  .pagination .page-link:focus{
    outline: none;
    box-shadow: 0 0 0 4px var(--launch-ring);
  }

  .pagination .page-item.active .page-link{
    background: var(--pg-active-bg);
    color: var(--pg-active-text);
    border-color: var(--pg-active-bg);
    box-shadow: 0 0 0 4px var(--launch-ring);
  }

  .pagination .page-item.disabled .page-link{
    color: var(--pg-muted);
    background: #f8fafc;
    border-color: var(--pg-border);
    opacity: .6;
  }

  /* Ellipsis */
  .pagination .page-item.disabled span.page-link{
    background: transparent;
    border: none;
    font-weight: 900;
    color: var(--muted);
    box-shadow: none;
  }

  /* Optional loading state for AJAX paging */
  .missionlog-loading{
    position: relative;
    pointer-events: none;
    opacity: .65;
  }
  .missionlog-loading::after{
    content:"";
    position:absolute;
    inset: 0;
    border-radius: 16px;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(241,245,249,.85) 50%, rgba(255,255,255,0) 100%);
    animation: shimmer 1.1s infinite;
  }
  @keyframes shimmer {
    0% { transform: translateX(-60%); }
    100% { transform: translateX(60%); }
  }

  /* ===== Inline Report polish ===== */
  .inline-report-wrap{
    margin-top: 10px;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,.08);
    background: #fff;
    overflow: hidden;
  }
  .inline-report-mount{
    padding: 12px;
  }
</style>

<div class="profile-wrapper">
  <header class="mb-4">
    <h1 style="font-weight: 800; color: var(--brand); letter-spacing: -1px;">Commander Profile</h1>
    <div class="header-accent-line"></div>
    <p class="text-muted mt-2">Strategic insights and decision-making metrics.</p>
  </header>

  <div class="bento-grid">
    <div class="bento-card persona-highlight">
      <div class="persona-tag">Decision DNA</div>
      <div id="personaLoading" class="opacity-75">
        <small class="spinner-border spinner-border-sm me-2"></small>
      </div>
      <div id="personaText" class="persona-quote" style="display:none;"></div>
      <div id="personaEmpty" class="empty-state text-white opacity-75" style="display:none;">
        <p>Complete a mission to unlock your profile.</p>
      </div>
    </div>

    <div class="bento-card stat-card-small">
      <div class="card-label">Emotional Index</div>
      <div class="card-sub">Sentiment distribution</div>
      <div id="chart-container-sentiment" style="height: 140px;">
        <canvas id="donutSentiment"></canvas>
      </div>
    </div>

    <div class="bento-card stat-card-med">
      <div class="card-label">Ethics & Strategy</div>
      <div class="card-sub">LOAC adherence</div>
      <div id="chart-container-ethics" style="height: 240px;">
        <canvas id="radarEthics"></canvas>
      </div>
    </div>

    <div class="bento-card stat-card-med">
      <div class="card-label">Performance Delta</div>
      <div class="card-sub">Confidence vs. Outcomes</div>
      <div id="chart-container-survey" style="height: 240px;">
        <canvas id="barSurvey"></canvas>
      </div>
    </div>
  </div>

  {# AJAX target wrapper: only this region is replaced on pagination #}
  <div class="missions-section" id="missionLogWrap">
    {% include "_profile_mission_log.html" %}
  </div>
</div>

<button type="button"
        class="fab-edit"
        data-bs-toggle="modal"
        data-bs-target="#editProfileModal"
        aria-label="Edit Profile">
  <span class="fab-dot"></span>
  Edit Profile
</button>

<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 18px; border: 1px solid rgba(0,0,0,.10);">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel" style="font-weight: 900; color: var(--brand);">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('profile_update') }}">
        <div class="modal-body">
          <div class="mb-3">
            <div class="small text-muted">Username</div>
            <div class="fw-bold">{{ user.username }}</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="gender">Gender</label>
              <select class="form-select" id="gender" name="gender">
                <option value="" {% if not user.gender %}selected{% endif %}>Prefer not to say</option>
                <option value="female" {% if user.gender == "female" %}selected{% endif %}>Female</option>
                <option value="male" {% if user.gender == "male" %}selected{% endif %}>Male</option>
                <option value="other" {% if user.gender == "other" %}selected{% endif %}>Other</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="age_group">Age Group</label>
              <select class="form-select" id="age_group" name="age_group">
                <option value="" {% if not user.age_group %}selected{% endif %}>Select</option>
                <option value="under-13" {% if user.age_group == "under-13" %}selected{% endif %}>Under 13</option>
                <option value="13-17" {% if user.age_group == "13-17" %}selected{% endif %}>13–17</option>
                <option value="18-24" {% if user.age_group == "18-24" %}selected{% endif %}>18–24</option>
                <option value="25-34" {% if user.age_group == "25-34" %}selected{% endif %}>25–34</option>
                <option value="35-plus" {% if user.age_group == "35-plus" %}selected{% endif %}>35+</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="preferred_war">Preferred War</label>
              <input class="form-control" id="preferred_war" name="preferred_war"
                     value="{{ user.preferred_war or '' }}"
                     placeholder="e.g. Korean War">
            </div>

            <div class="col-md-6">
              <label class="form-label" for="interest">Interest</label>
              <input class="form-control" id="interest" name="interest"
                     value="{{ user.interest or '' }}"
                     placeholder="e.g. evacuation ethics, leadership">
            </div>

            <div class="col-12">
              <div class="small text-muted mb-2">Leave password blank to keep your current password.</div>
              <label class="form-label" for="new_password">New Password (optional)</label>
              <input class="form-control" id="new_password" name="new_password" type="password" placeholder="••••••••">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-save-warm">Save</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const STATS = {{ stats|tojson }};

  function initChart(chartId, containerId, hasData, config) {
    const container = document.getElementById(containerId);
    if (!hasData) {
      container.innerHTML = `<div class="empty-state"><p>Insufficient data</p></div>`;
      return null;
    }
    return new Chart(document.getElementById(chartId), config);
  }

  (async () => {
    const loader = document.getElementById("personaLoading");
    const text = document.getElementById("personaText");
    const empty = document.getElementById("personaEmpty");
    try {
      const res = await fetch("/api/persona");
      const data = await res.json();
      loader.style.display = "none";
      if (data.persona) {
        text.style.display = "block";
        text.textContent = `"${data.persona}"`;
      } else {
        empty.style.display = "flex";
      }
    } catch (e) {
      loader.style.display = "none";
      empty.style.display = "flex";
    }
  })();

  initChart('radarEthics', 'chart-container-ethics', !!STATS.dimensions_norm, {
    type: 'radar',
    data: {
      labels: ['Distinction', 'Proportionality', 'Necessity', 'Precaution'],
      datasets: [{
        data: ['Distinction','Proportionality','Necessity','Precaution'].map(k => STATS.dimensions_norm?.[k] ?? 0),
        backgroundColor: 'rgba(87, 69, 69, 0.1)',
        borderColor: '#574545',
        borderWidth: 2
      }]
    },
    options: { scales: { r: { beginAtZero: true, max: 1, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
  });

  /* FIX 1: Donut uses decision emotion labels (STATS.emotional.dist) */
  const emoDist = STATS.emotional?.dist || {};
  const emoKeys = ['calm', 'confident', 'conflicted', 'anxious', 'distressed', 'unknown'];
  const emoCounts = emoKeys.map(k => emoDist[k] || 0);

  const hasSentiment =
    (emoCounts.reduce((a,b)=>a+b,0) > 0) ||
    ((STATS.emotional?.count || 0) > 0) ||
    (typeof STATS.emotional?.avg === "number");

  initChart('donutSentiment', 'chart-container-sentiment', hasSentiment, {
    type: 'doughnut',
    data: {
      labels: ['Calm', 'Confident', 'Conflicted', 'Anxious', 'Distressed', 'Unknown'],
      datasets: [{
        data: emoCounts,
        backgroundColor: ['#ab8e8e', '#cbd5e1', '#94a3b8', '#f59e0b', '#574545', '#e2e8f0'],
        borderWidth: 0
      }]
    },
    options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 9, weight: 'bold' } } } }, maintainAspectRatio: false }
  });

  /* FIX 2: Bar chart hasAny accepts numeric averages even if count fields are missing */
  const hasStepSurvey =
    ((STATS.step_survey?.count || 0) > 0) ||
    (typeof STATS.step_survey?.confidence_avg === "number") ||
    (typeof STATS.step_survey?.morality_avg === "number") ||
    (typeof STATS.step_survey?.sentiment_avg === "number");

  const hasEmoBar =
    ((STATS.emotional?.count || 0) > 0) ||
    (typeof STATS.emotional?.avg === "number");

  const hasAny = hasStepSurvey || hasEmoBar;

  initChart('barSurvey', 'chart-container-survey', hasAny, {
    type: 'bar',
    data: {
      labels: ['Confidence', 'Morality', 'Sentiment', 'Emotional Index'],
      datasets: [
        {
          label: 'Average',
          data: [
            (typeof STATS.step_survey?.confidence_avg === "number" ? STATS.step_survey.confidence_avg : null),
            (typeof STATS.step_survey?.morality_avg === "number" ? STATS.step_survey.morality_avg : null),
            (typeof STATS.step_survey?.sentiment_avg === "number" ? STATS.step_survey.sentiment_avg : null),
            (typeof STATS.emotional?.avg === "number" ? STATS.emotional.avg : null)
          ],
          borderRadius: 4
        }
      ]
    },
    options: {
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, max: 1 }, x: { grid: { display: false } } },
      plugins: { legend: { display: false } }
    }
  });

  /* =========================
     Inline Ethics Report loader
     - buttons live inside _profile_mission_log.html
     - expects /run/<id>/result?partial=1 -> { html }
     ========================= */
  (function(){
    const wrap = document.getElementById("missionLogWrap");
    if (!wrap) return;

    const loaded = new Set();

    async function loadInlineReport(runId){
      if (!runId || loaded.has(runId)) return;

      const mount = document.getElementById(`reportMount${runId}`);
      if (!mount) return;

      try{
        const res = await fetch(`/run/${runId}/result?partial=1`, {
          headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if (!data || typeof data.html !== "string") throw new Error("Bad payload");

        mount.innerHTML = data.html;
        loaded.add(runId);
      } catch (e){
        mount.innerHTML = `
          <div class="empty-state" style="background: var(--empty-bg); border-radius: 14px; padding: 18px;">
                <p class="m-0">Sorry, the research report is currently unavailable for research purposes.</p>
          </div>
        `;
      }
    }

    wrap.addEventListener("click", (e) => {
      const btn = e.target.closest(".btn-view-report");
      if (!btn) return;

      const runId = btn.getAttribute("data-run-id");
      loadInlineReport(runId);
    });

    // reset cache when mission log is replaced by pagination
    function resetLoaded(){
      loaded.clear();
    }

    // observe missionLogWrap inner HTML replacement (AJAX paging)
    const obs = new MutationObserver(() => resetLoaded());
    obs.observe(wrap, { childList: true, subtree: false });
  })();

  /* =========================
     AJAX Pagination (no refresh)
     Requires /profile?partial=1 to return JSON: { html, page, total_pages }
     ========================= */
  (function(){
    const wrap = document.getElementById("missionLogWrap");
    if (!wrap) return;

    let inFlight = false;

    function setLoading(on){
      if (on) wrap.classList.add("missionlog-loading");
      else wrap.classList.remove("missionlog-loading");
    }

    async function loadPage(href){
      if (!href || inFlight) return;
      inFlight = true;
      setLoading(true);

      const y = window.scrollY || 0;

      try{
        const u = new URL(href, window.location.origin);
        u.searchParams.set("partial", "1");

        const res = await fetch(u.toString(), { headers: { "Accept": "application/json" }});
        if (!res.ok) throw new Error("Request failed: " + res.status);

        const data = await res.json();
        if (!data || typeof data.html !== "string") throw new Error("Bad JSON payload");

        wrap.innerHTML = data.html;

        const pageParam = (new URL(href, window.location.origin)).searchParams.get("page") || "1";
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set("page", pageParam);
        history.pushState({ page: pageParam }, "", newUrl.toString());

        window.scrollTo(0, y);
      } catch (err){
        window.location.href = href;
      } finally {
        setLoading(false);
        inFlight = false;
      }
    }

    wrap.addEventListener("click", (e) => {
      const a = e.target.closest("a.page-link");
      if (!a) return;

      const li = a.closest(".page-item");
      if (li && li.classList.contains("disabled")) {
        e.preventDefault();
        return;
      }

      e.preventDefault();
      loadPage(a.getAttribute("href"));
    });

    window.addEventListener("popstate", () => {
      const page = new URL(window.location.href).searchParams.get("page") || "1";
      loadPage(`/profile?page=${page}`);
    });
  })();
</script>

{% endblock %}
