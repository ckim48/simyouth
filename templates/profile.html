{# templates/profile.html #}
{% extends "base.html" %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --brand-dark: #3f3434;
    --card-shadow: 0 8px 20px -6px rgba(0, 0, 0, 0.05);
    --empty-bg: #f1f5f9;
  }

  body { font-family: 'Inter', sans-serif; color: var(--ink); }
  .profile-wrapper { max-width: 1200px; margin: 0 auto; padding-bottom: 60px; }

  /* Bento Grid */
  .bento-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-bottom: 40px; }
  .bento-card {
    background: #ffffff; border-radius: var(--radius); padding: 24px;
    border: 1px solid var(--line); box-shadow: var(--card-shadow); position: relative;
  }

  /* Sizing */
  .persona-highlight { grid-column: span 7; background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%); color: white; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
  .stat-card-small { grid-column: span 5; }
  .stat-card-med { grid-column: span 6; }
  .stat-card-wide { grid-column: span 12; }

  /* Empty State UI */
  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; width: 100%; text-align: center; color: var(--muted); padding: 20px;
  }
  .empty-state i { font-size: 1.5rem; margin-bottom: 8px; opacity: 0.5; }
  .empty-state p { font-size: 0.85rem; font-weight: 600; margin: 0; }

  /* Typography */
  .persona-tag { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: var(--brand-light); letter-spacing: 0.12em; margin-bottom: 8px; }
  .persona-quote { font-size: 1.35rem; font-weight: 700; line-height: 1.3; }
  .card-label { font-size: 0.9rem; font-weight: 800; color: var(--ink); }
  .card-sub { font-size: 0.8rem; color: var(--muted); margin-bottom: 16px; }

  /* Mission Rows */
  .mission-row { background: white; border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 12px; padding: 16px 20px; }
  .badge-mission { background: rgba(87, 69, 69, 0.08); color: var(--brand); padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; }

  @media (max-width: 992px) { .persona-highlight, .stat-card-small { grid-column: span 12; } }
</style>

<div class="profile-wrapper">
  <header class="mb-4">
    <h1 style="font-weight: 800; color: var(--brand); letter-spacing: -1px;">Commander Profile</h1>
    <p class="text-muted">Strategic insights and decision-making metrics.</p>
  </header>

  <div class="bento-grid">
    <div class="bento-card persona-highlight">
      <div class="persona-tag">Decision DNA</div>
      <div id="personaLoading" class="opacity-75">
        <small class="spinner-border spinner-border-sm me-2"></small>
      </div>
      <div id="personaText" class="persona-quote" style="display:none;"></div>
      <div id="personaEmpty" class="empty-state text-white opacity-75" style="display:none;">
        <p>Complete a mission to unlock your profile.</p>
      </div>
    </div>

    <div class="bento-card stat-card-small">
      <div class="card-label">Emotional Index</div>
      <div class="card-sub">Sentiment distribution</div>
      <div id="chart-container-sentiment" style="height: 140px;">
        <canvas id="donutSentiment"></canvas>
      </div>
    </div>

    <div class="bento-card stat-card-med">
      <div class="card-label">Ethics & Strategy</div>
      <div class="card-sub">LOAC adherence</div>
      <div id="chart-container-ethics" style="height: 240px;">
        <canvas id="radarEthics"></canvas>
      </div>
    </div>

    <div class="bento-card stat-card-med">
      <div class="card-label">Performance Delta</div>
      <div class="card-sub">Confidence vs. Outcomes</div>
      <div id="chart-container-survey" style="height: 240px;">
        <canvas id="barSurvey"></canvas>
      </div>
    </div>
  </div>

  <div class="missions-section">
    <h3 class="mb-4" style="font-weight: 800; color: var(--brand); font-size: 1.5rem;">Mission Log</h3>

    {% if runs %}
      {% for r in runs %}
      <div class="mission-row">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <span class="badge-mission">{{ r.run_type }}</span>
            <span class="fw-bold">{{ r.title }}</span>
          </div>
          <button class="btn btn-sm btn-outline-secondary fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#run-{{ r.id }}">Review</button>
        </div>
        <div id="run-{{ r.id }}" class="collapse mt-3">
          <div class="pt-3 border-top">
            {% for d in r.decisions %}
              <div style="border-left: 2px solid var(--line); margin-left: 8px; padding: 0 0 20px 20px; position: relative;">
                <div style="font-size: 0.6rem; font-weight: 800; color: var(--brand-light);">STEP {{ loop.index }}</div>
                <div class="fw-bold small">{{ d.step_title }}</div>
                <div class="small">Decision: <span class="fw-bold" style="color: var(--brand)">{{ d.chosen_label }}</span></div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="bento-card text-center py-5">
        <p class="text-muted fw-bold">No missions recorded yet. Start your first scenario to see your log.</p>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const STATS = {{ stats|tojson }};

  // Helper to handle empty states for charts
  function initChart(chartId, containerId, hasData, config) {
    const container = document.getElementById(containerId);
    if (!hasData) {
      container.innerHTML = `<div class="empty-state"><p>Insufficient data</p></div>`;
      return null;
    }
    return new Chart(document.getElementById(chartId), config);
  }

  // 1. Persona
  (async () => {
    const loader = document.getElementById("personaLoading");
    const text = document.getElementById("personaText");
    const empty = document.getElementById("personaEmpty");
    try {
      const res = await fetch("/api/persona");
      const data = await res.json();
      loader.style.display = "none";
      if (data.persona) {
        text.style.display = "block";
        text.textContent = `"${data.persona}"`;
      } else {
        empty.style.display = "flex";
      }
    } catch (e) {
      loader.style.display = "none";
      empty.style.display = "flex";
    }
  })();

  // 2. Radar
  initChart('radarEthics', 'chart-container-ethics', !!STATS.dimensions_norm, {
    type: 'radar',
    data: {
      labels: ['Distinction', 'Proportionality', 'Necessity', 'Precaution'],
      datasets: [{
        data: ['Distinction','Proportionality','Necessity','Precaution'].map(k => STATS.dimensions_norm?.[k] ?? 0),
        backgroundColor: 'rgba(87, 69, 69, 0.1)',
        borderColor: '#574545',
        borderWidth: 2
      }]
    },
    options: { scales: { r: { beginAtZero: true, max: 1, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
  });

  // 3. Donut
  const hasSentiment = STATS.sentiment?.dist?.positive || STATS.sentiment?.dist?.neutral || STATS.sentiment?.dist?.negative;
  initChart('donutSentiment', 'chart-container-sentiment', hasSentiment, {
    type: 'doughnut',
    data: {
      labels: ['Pos', 'Neu', 'Neg'],
      datasets: [{
        data: [STATS.sentiment?.dist?.positive || 0, STATS.sentiment?.dist?.neutral || 0, STATS.sentiment?.dist?.negative || 0],
        backgroundColor: ['#ab8e8e', '#cbd5e1', '#574545'],
        borderWidth: 0
      }]
    },
    options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 9, weight: 'bold' } } } }, maintainAspectRatio: false }
  });

  // 4. Bar
  const hasSurvey = STATS.survey?.pre_confidence_avg || STATS.survey?.post_satisfaction_avg;
  initChart('barSurvey', 'chart-container-survey', hasSurvey, {
    type: 'bar',
    data: {
      labels: ['Confidence', 'Satisfaction', 'Sentiment'],
      datasets: [
        { label: 'Initial', data: [STATS.survey?.pre_confidence_avg, null, STATS.sentiment?.pre_avg], backgroundColor: '#e2e8f0', borderRadius: 4 },
        { label: 'Final', data: [null, STATS.survey?.post_satisfaction_avg, STATS.sentiment?.post_avg], backgroundColor: '#574545', borderRadius: 4 }
      ]
    },
    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 1 }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
  });
</script>

{% endblock %}