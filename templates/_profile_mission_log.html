{# templates/_profile_mission_log.html #}

<div class="bento-card stat-card-wide">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <div class="card-label">Mission Log</div>
      <div class="card-sub">Completed missions only. Click to view the final Ethics Report inline.</div>
    </div>
    {% if page is defined and total_pages is defined %}
      <span class="badge-mission">Page {{ page }} / {{ total_pages }}</span>
    {% endif %}
  </div>

  {# ✅ Only show completed missions (finished_at exists) #}
  {% set completed_runs = [] %}
  {% if runs and runs|length > 0 %}
    {% for r in runs %}
      {% if r.finished_at %}
        {% set _ = completed_runs.append(r) %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if completed_runs and completed_runs|length > 0 %}
    {% for r in completed_runs %}
      <div class="mission-row" id="missionRow{{ r.id }}">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div class="d-flex flex-column">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="badge-mission">{{ (r.run_type or "mission")|upper }}</span>
              <div class="fw-bold" style="color: var(--brand);">
                {{ r.title or "Untitled Mission" }}
              </div>
            </div>
            <div class="small text-muted">
              Started: {{ r.started_at or "—" }}
              <span class="mx-1">·</span>
              Completed: {{ r.finished_at }}
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button type="button"
                    class="btn btn-sm fw-bold btn-view-report"
                    style="background: var(--launch); color:#fff; border-radius: 12px;"
                    data-run-id="{{ r.id }}">
              View Report
            </button>
          </div>
        </div>

        {# Inline report mount point #}
        <div id="reportMount{{ r.id }}" style="margin-top: 12px;"></div>
      </div>
    {% endfor %}

    {% if total_pages is defined and total_pages|int > 1 %}
      <div class="pager-wrap">
        <div class="pager-meta">
          {% if page is defined %}
            Page {{ page }} of {{ total_pages }}
          {% endif %}
        </div>

        <nav aria-label="Mission log pages">
          <ul class="pagination mb-0">
            {# Prev #}
            <li class="page-item {% if page|int <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('profile', page=(page|int - 1)) }}">Prev</a>
            </li>

            {# Page numbers #}
            {% for p in range(1, (total_pages|int) + 1) %}
              {% if p == page|int %}
                <li class="page-item active"><a class="page-link" href="{{ url_for('profile', page=p) }}">{{ p }}</a></li>
              {% elif p == 1 or p == total_pages|int or (p >= page|int - 1 and p <= page|int + 1) %}
                <li class="page-item"><a class="page-link" href="{{ url_for('profile', page=p) }}">{{ p }}</a></li>
              {% elif p == page|int - 2 or p == page|int + 2 %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}

            {# Next #}
            <li class="page-item {% if page|int >= total_pages|int %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('profile', page=(page|int + 1)) }}">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    {% endif %}

  {% else %}
    <div class="empty-state" style="background: var(--empty-bg); border-radius: 16px; padding: 28px;">
      <p>No completed missions yet. Finish a scenario to unlock your Mission Log.</p>
    </div>
  {% endif %}
</div>
